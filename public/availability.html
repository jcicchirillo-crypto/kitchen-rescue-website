<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Availability ‚Ä¢ Kitchen Rescue</title>
    <link rel="icon" type="image/png" href="/assets/logo-lockup-final.png">
    <link rel="stylesheet" href="/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QM819YH8XY"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-QM819YH8XY');
    </script>
    
    <style>
        .availability-container { max-width: 1024px; margin: 0 auto; padding: 2rem 1rem; }
        .availability-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
        .availability-title { font-size: 1.5rem; font-weight: 600; }
        .postcode-pill { font-size: 0.875rem; color: #374151; }
        .calendar-grid { display: grid; gap: 1rem; }
        @media (min-width: 768px) { .calendar-grid { grid-template-columns: repeat(2, 1fr); } }
        .calendar { border: 1px solid #e5e7eb; border-radius: 1rem; padding: 1rem; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
        .calendar h3 { font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem; }
        .weekday-row, .date-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem; }
        .weekday { text-align: center; font-size: 0.75rem; color: #6b7280; padding: 0.25rem 0; }
        .date { text-align: center; padding: 0.5rem 0; border-radius: 0.5rem; font-size: 0.875rem; }
        .date.disabled { color: #9ca3af; background: #f3f4f6; cursor: not-allowed; }
        .date.available { background: #ecfdf5; color: #065f46; border: 1px solid #a7f3d0; cursor: pointer; }
        .legend { display: flex; gap: 1rem; align-items: center; font-size: 0.875rem; color: #6b7280; margin-top: 0.75rem; }
        .badge { width: 0.75rem; height: 0.75rem; border-radius: 0.25rem; display: inline-block; margin-right: 0.25rem; }
        .badge-available { background: #a7f3d0; border: 1px solid #34d399; }
        .badge-unavailable { background: #e5e7eb; border: 1px solid #d1d5db; }
        .past-date { text-decoration: line-through; opacity: 0.6; }
        .date.selected { 
            background: #dc2626 !important; 
            color: #fff !important; 
            border: 1px solid #b91c1c !important; 
        }
        .tools { display: flex; gap: 0.5rem; align-items: center; margin-top: 0.75rem; }
        .input { border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.5rem 0.75rem; font-size: 0.875rem; }
        .btn { border-radius: 0.75rem; padding: 0.6rem 0.9rem; font-size: 0.875rem; font-weight: 500; border: none; cursor: pointer; }
        .btn-primary { background-color: #dc2626; color: #fff; }
        .notice { margin-top: 1rem; font-size: 0.875rem; color: #6b7280; }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <a href="index.html">
                        <img src="/assets/logo-lockup-final.png" alt="Kitchen Rescue" class="logo-img">
                    </a>
                    <a href="availability.html" class="mobile-availability">Availability</a>
                </div>
                <nav class="nav">
                    <a href="index.html" class="nav-link">Home</a>
                    <a href="index.html#features" class="nav-link">Features</a>
                    <a href="index.html#spec" class="nav-link">Spec</a>
                    <a href="index.html#gallery" class="nav-link">Gallery</a>
                    <a href="index.html#faqs" class="nav-link">FAQs</a>
                    <a href="index.html#contact" class="nav-link nav-cta">Contact</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="availability-container">
        <!-- Back to main site button -->
        <div style="margin-bottom: 1rem;">
            <a href="index.html" class="btn btn-secondary" style="display: inline-flex; align-items: center; gap: 0.5rem; background-color: #6b7280; color: #fff; text-decoration: none;">
                ‚Üê Back to Main Site
            </a>
        </div>
        
        <div class="availability-header">
            <p class="availability-title">Check availability</p>
            <p id="postcodePill" class="postcode-pill"></p>
        </div>
        <div class="tools">
            <input id="postcodeInput" class="input" placeholder="Enter postcode (e.g. EN10)">
            <button id="updatePostcodeBtn" class="btn btn-primary">Update</button>
        </div>
        <div class="legend">
            <span><span class="badge badge-available"></span>Available</span>
            <span><span class="badge badge-unavailable"></span>Unavailable</span>
        </div>
        <div class="calendar-controls" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
            <button id="prevMonthBtn" class="btn" style="border: 1px solid #d1d5db;">‚Üê Previous</button>
            <span id="currentMonthDisplay" style="font-weight: 500;"></span>
            <button id="nextMonthBtn" class="btn" style="border: 1px solid #d1d5db;">Next ‚Üí</button>
        </div>
        <div id="calendarGrid" class="calendar-grid" aria-live="polite"></div>
        
        <div id="pricingCalculator" class="pricing-calculator" style="display: none; margin-top: 1.5rem; padding: 1.5rem; background: #f9fafb; border-radius: 1rem; border: 1px solid #e5e7eb;">
            <h3 style="margin-bottom: 1rem; font-size: 1.25rem; font-weight: 600;">Quote Calculator</h3>
            <div id="selectedDates" style="margin-bottom: 1rem; font-size: 0.875rem; color: #6b7280;"></div>
            <div id="pricingBreakdown" style="display: grid; gap: 0.75rem;"></div>
            <div id="totalCost" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; font-size: 1.125rem; font-weight: 600; color: #dc2626;"></div>
            <div style="text-align: center; margin-top: 1.5rem;">
                <button id="bookNowBtn" class="btn btn-primary" style="padding: 0.75rem 2rem; font-size: 1.125rem; font-weight: 600; margin-right: 1rem;">
                    üìÖ Book Now
                </button>
                <button id="emailQuoteBtn" class="btn" style="padding: 0.75rem 2rem; font-size: 1.125rem; font-weight: 600; border: 1px solid #d1d5db; background: #ffffff; color: #374151;">
                    üìß Email Quote
                </button>
            </div>
        </div>
        
        <p class="notice">Note: This calendar is for guidance. We'll confirm your exact delivery window after you request a quote.</p>

        <hr style="margin: 2rem 0; border: none; border-top: 1px solid #e5e7eb;" />
        <section id="adminSection" aria-labelledby="manage-heading" style="display: none;">
            <h2 id="manage-heading" class="availability-title" style="margin-bottom: 0.5rem;">Manage unavailable dates</h2>
            <p class="postcode-pill" style="margin-bottom: 0.75rem;">Add date ranges to block out bookings.</p>
            <div class="tools" style="flex-wrap: wrap; gap: 0.75rem;">
                <label>
                    <span style="font-size: 0.75rem; color: #6b7280;">Start</span><br>
                    <input id="rangeStart" type="date" class="input">
                </label>
                <label>
                    <span style="font-size: 0.75rem; color: #6b7280;">End</span><br>
                    <input id="rangeEnd" type="date" class="input">
                </label>
                <button id="addRangeBtn" class="btn btn-primary">Add range</button>
                <button id="clearRangesBtn" class="btn" style="border: 1px solid #d1d5db;">Clear all</button>
                <button id="downloadBtn" class="btn" style="border: 1px solid #d1d5db;">Download JSON</button>
                <button id="copyJsonBtn" class="btn" style="border: 1px solid #d1d5db;">Copy JSON</button>
            </div>
            <ul id="rangesList" style="margin-top: 0.75rem; list-style: none; padding: 0; display: grid; gap: 0.5rem;"></ul>
        </section>
    </main>

    <!-- Email Quote Modal -->
    <div id="emailQuoteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 1rem; padding: 2rem; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin-bottom: 1rem; font-size: 1.25rem; font-weight: 600;">üìß Email Quote</h3>
            <p style="color: #6b7280; margin-bottom: 1.5rem; font-size: 0.875rem;">We'll send your personalized quote to your email address.</p>
            
            <form id="emailQuoteForm">
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Your Name *</label>
                    <input type="text" id="quoteName" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem;">
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Email Address *</label>
                    <input type="email" id="quoteEmail" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem;">
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Phone Number</label>
                    <input type="tel" id="quotePhone" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem;">
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Additional Notes</label>
                    <textarea id="quoteNotes" rows="3" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem; resize: vertical;" placeholder="Any specific requirements or questions?"></textarea>
                </div>
                
                <div id="emailQuoteMessage" style="margin-bottom: 1rem; padding: 1rem; border-radius: 0.5rem; display: none;"></div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" id="cancelEmailQuote" class="btn" style="border: 1px solid #d1d5db; background: #ffffff; color: #374151; padding: 0.75rem 1.5rem;">
                        Cancel
                    </button>
                    <button type="submit" id="sendEmailQuote" class="btn btn-primary" style="padding: 0.75rem 1.5rem;">
                        üìß Send Quote
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        console.log('Script tag reached');
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded');
            
            // Check for URL parameters from email quote
            const urlParams = new URLSearchParams(window.location.search);
            const emailDates = urlParams.get('dates');
            const emailPostcode = urlParams.get('postcode');
            
            // If coming from email quote, auto-select dates and postcode
            if (emailDates && emailPostcode) {
                console.log('Email quote detected - auto-selecting dates:', emailDates);
                console.log('Email quote detected - auto-filling postcode:', emailPostcode);
                
                // Fill in postcode
                const postcodeInput = document.getElementById('postcodeInput');
                if (postcodeInput) {
                    postcodeInput.value = emailPostcode;
                    // Update postcode pill
                    const postcodePill = document.getElementById('postcodePill');
                    postcodePill.textContent = `Postcode: ${emailPostcode}`;
                }
                
                // Parse and select dates
                const dateArray = emailDates.split(',');
                selectedDates = dateArray;
                console.log('Auto-selected dates:', selectedDates);
            }
            
            // Postcode update handler
            const updateBtn = document.getElementById('updatePostcodeBtn');
            if (updateBtn) {
                updateBtn.addEventListener('click', () => {
                    const pc = document.getElementById('postcodeInput').value.toUpperCase().trim();
                    const params = new URLSearchParams(window.location.search);
                    if (pc) params.set('postcode', pc); else params.delete('postcode');
                    window.history.replaceState({}, '', `${window.location.pathname}?${params.toString()}`);
                    
                    // Update postcode pill
                    const postcodePill = document.getElementById('postcodePill');
                    postcodePill.textContent = pc ? `Postcode: ${pc}` : '';
                    
                    // Refresh pricing if dates are selected
                    if (selectedDates.length > 0) {
                        updatePricingCalculator();
                    }
                });
            }
            
            // Book Now button handler
            const bookNowBtn = document.getElementById('bookNowBtn');
            if (bookNowBtn) {
                bookNowBtn.addEventListener('click', () => {
                    if (selectedDates.length === 0) {
                        alert('Please select your dates first');
                        return;
                    }
                    
                    const postcode = document.getElementById('postcodeInput').value.toUpperCase().trim();
                    if (!postcode) {
                        alert('Please enter your postcode first');
                        return;
                    }
                    
                    // Navigate to booking flow with selected data
                    const params = new URLSearchParams();
                    params.set('dates', selectedDates.join(','));
                    params.set('postcode', postcode);
                    window.location.href = `booking-checklist.html?${params.toString()}`;
                });
            }
            
            // Email Quote button handler
            const emailQuoteBtn = document.getElementById('emailQuoteBtn');
            if (emailQuoteBtn) {
                emailQuoteBtn.addEventListener('click', () => {
                    if (selectedDates.length === 0) {
                        alert('Please select your dates first');
                        return;
                    }
                    
                    const postcode = document.getElementById('postcodeInput').value.toUpperCase().trim();
                    if (!postcode) {
                        alert('Please enter your postcode first');
                        return;
                    }
                    
                    // Show email form modal
                    showEmailQuoteModal();
                });
            }
            
            // Load calendar
            loadCalendar();
            
            // If we have auto-selected dates from email, highlight them after calendar loads
            if (emailDates && emailPostcode) {
                setTimeout(() => {
                    // Check if all dates are still available
                    const unavailableDates = checkDateAvailability(emailDates.split(','));
                    
                    if (unavailableDates.length > 0) {
                        // Some dates are no longer available
                        showDateUnavailableMessage(unavailableDates);
                        // Clear the selected dates since some are unavailable
                        selectedDates = [];
                    } else {
                        // All dates are still available
                        highlightAllSelectedDates();
                        updatePricingCalculator();
                    }
                }, 1000); // Wait for calendar to fully load
            }
        });
        
        let currentMonth = new Date(2025, 11, 1); // December 1st, 2025
        let selectedDates = [];
        let availabilityData = { unavailable: [] };
        
        function loadCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const currentMonthDisplay = document.getElementById('currentMonthDisplay');
            const prevMonthBtn = document.getElementById('prevMonthBtn');
            const nextMonthBtn = document.getElementById('nextMonthBtn');
            
            // Load availability data
            fetch('assets/availability.json')
                .then(r => r.json())
                .then(data => {
                    availabilityData = data;
                    renderAll();
                })
                .catch(() => {
                    availabilityData = { unavailable: [] };
                    renderAll();
                });
            
            // Navigation handlers
            const startDate = new Date(2025, 11, 1); // December 1st, 2025
            
            prevMonthBtn.addEventListener('click', () => {
                const prevMonth = new Date(currentMonth);
                prevMonth.setMonth(prevMonth.getMonth() - 1);
                
                // Don't allow going before December 2025
                if (prevMonth >= startDate) {
                    currentMonth.setMonth(currentMonth.getMonth() - 1);
                    renderAll();
                }
            });
            
            nextMonthBtn.addEventListener('click', () => {
                currentMonth.setMonth(currentMonth.getMonth() + 1);
                renderAll();
            });
            
            function renderAll() {
                console.log('=== RENDERING CALENDAR ===');
                calendarGrid.innerHTML = '';
                const nextMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
                console.log('Rendering months:', currentMonth.toLocaleString(), 'and', nextMonth.toLocaleString());
                
                calendarGrid.appendChild(renderMonth(currentMonth, availabilityData));
                calendarGrid.appendChild(renderMonth(nextMonth, availabilityData));
                currentMonthDisplay.textContent = `${currentMonth.toLocaleString(undefined, { month: 'long', year: 'numeric' })} & ${nextMonth.toLocaleString(undefined, { month: 'long', year: 'numeric' })}`;
                
                console.log('Calendar rendered, available dates:', document.querySelectorAll('.date.available').length);
                
                // Re-highlight selected dates after rendering
                highlightAllSelectedDates();
                console.log('=== END RENDERING ===');
            }
        }
        
        function renderMonth(monthStart, availability) {
            const container = document.createElement('div');
            container.className = 'calendar';
            
            const title = document.createElement('h3');
            title.textContent = monthStart.toLocaleString(undefined, { month: 'long', year: 'numeric' });
            container.appendChild(title);
            
            const weekdayRow = document.createElement('div');
            weekdayRow.className = 'weekday-row';
            ['Mo','Tu','We','Th','Fr','Sa','Su'].forEach(d => {
                const el = document.createElement('div');
                el.className = 'weekday';
                el.textContent = d;
                weekdayRow.appendChild(el);
            });
            container.appendChild(weekdayRow);
            
            const dateGrid = document.createElement('div');
            dateGrid.className = 'date-grid';
            
            const firstDay = new Date(monthStart.getFullYear(), monthStart.getMonth(), 1);
            const lastDay = new Date(monthStart.getFullYear(), monthStart.getMonth() + 1, 0);
            
            // Leading blanks
            const lead = (firstDay.getDay() + 6) % 7; // Convert to Mon-based week
            for (let i = 0; i < lead; i++) dateGrid.appendChild(document.createElement('div'));
            
            // Unavailable dates
            const unavailableSet = new Set();
            (availability.unavailable || []).forEach(r => {
                const start = new Date(r.start);
                const end = new Date(r.end);
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    unavailableSet.add(d.toISOString().slice(0,10));
                }
            });
            
            const today = new Date();
            const startDateStr = '2025-12-01'; // December 1st, 2025
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(monthStart.getFullYear(), monthStart.getMonth(), day);
                const iso = date.toISOString().slice(0,10);
                const cell = document.createElement('div');
                cell.className = 'date';
                cell.setAttribute('data-date', iso); // Add data attribute for easy finding
                const isUnavailable = unavailableSet.has(iso);
                const isPast = iso < startDateStr; // Use startDate instead of today
                cell.classList.add(isUnavailable ? 'disabled' : 'available');
                if (isPast) cell.classList.add('past-date');
                cell.textContent = String(day);
                
                // Add click handler for available dates
                if (!isUnavailable && !isPast) {
                    cell.style.cursor = 'pointer';
                    console.log('Adding click handler to date:', iso, 'Day:', day);
                    
                    cell.onclick = function(event) {
                        console.log('=== CLICK EVENT TRIGGERED ===');
                        console.log('Event:', event);
                        console.log('Clicked date:', iso);
                        console.log('Current selectedDates:', selectedDates);
                        
                        // Check if this date is part of any selected 7-day block
                        const isInSelectedBlock = isDateInSelectedBlock(iso);
                        console.log('Is in selected block:', isInSelectedBlock);
                        
                        if (isInSelectedBlock) {
                            // Deselecting - remove the 7-day block containing this date
                            console.log('Removing block containing:', iso);
                            removeSevenDayBlockContaining(iso);
                        } else {
                            // Selecting - automatically select 7-day block starting from this date
                            console.log('Selecting 7-day block starting from:', iso);
                            selectSevenDayBlock(iso);
                        }
                        
                        // Update display
                        highlightAllSelectedDates();
                        updatePricingCalculator();
                        
                        console.log('=== END CLICK ===');
                    };
                    
                    // Test if the click handler was attached
                    console.log('Click handler attached to cell:', cell.onclick !== null);
                }
                
                dateGrid.appendChild(cell);
            }
            
            container.appendChild(dateGrid);
            return container;
        }
        
        
        // Date selection and pricing functions
        function toggleDateSelection(dateStr, cell) {
            console.log('toggleDateSelection called for:', dateStr);
            console.log('Current selectedDates:', selectedDates);
            
            // Check if this date is part of any selected 7-day block
            const isInSelectedBlock = isDateInSelectedBlock(dateStr);
            console.log('Is in selected block:', isInSelectedBlock);
            
            if (isInSelectedBlock) {
                // Deselecting - remove the 7-day block containing this date
                console.log('Removing block containing:', dateStr);
                removeSevenDayBlockContaining(dateStr);
            } else {
                // Selecting - automatically select 7-day block starting from this date
                console.log('Selecting 7-day block starting from:', dateStr);
                selectSevenDayBlock(dateStr);
            }
            updatePricingCalculator();
        }
        
        function isDateInSelectedBlock(dateStr) {
            // Check if this date is in any selected 7-day block
            for (let i = 0; i < selectedDates.length; i += 7) {
                const blockStart = new Date(selectedDates[i]);
                const blockEnd = new Date(blockStart);
                blockEnd.setDate(blockStart.getDate() + 6);
                
                const targetDate = new Date(dateStr);
                if (targetDate >= blockStart && targetDate <= blockEnd) {
                    return true;
                }
            }
            return false;
        }
        
        function removeSevenDayBlockContaining(dateStr) {
            const targetDate = new Date(dateStr);
            
            // Find which 7-day block contains this date
            for (let i = 0; i < selectedDates.length; i += 7) {
                const blockStart = new Date(selectedDates[i]);
                const blockEnd = new Date(blockStart);
                blockEnd.setDate(blockStart.getDate() + 6);
                
                if (targetDate >= blockStart && targetDate <= blockEnd) {
                    // Remove this entire 7-day block
                    selectedDates.splice(i, 7);
                    break;
                }
            }
            
            highlightAllSelectedDates();
        }
        
        function selectSevenDayBlock(startDateStr) {
            console.log('selectSevenDayBlock called for:', startDateStr);
            const startDate = new Date(startDateStr);
            const newBlockDates = [];
            
            // Check if all 7 days are available
            for (let i = 0; i < 7; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                const dateStr = currentDate.toISOString().slice(0, 10);
                
                console.log(`Checking day ${i + 1} of 7-day block:`, dateStr);
                
                if (isDateAvailable(dateStr)) {
                    newBlockDates.push(dateStr);
                    console.log('‚úì Date is available:', dateStr);
                } else {
                    console.log('‚úó Date is NOT available:', dateStr);
                    console.log('Cannot select 7-day block - unavailable date:', dateStr);
                    alert(`Cannot select 7-day block - ${dateStr} is unavailable.`);
                    return;
                }
            }
            
            console.log('All 7 days are available. Adding new block dates:', newBlockDates);
            
            // Add the new block to selected dates
            selectedDates.push(...newBlockDates);
            selectedDates.sort();
            
            console.log('Updated selectedDates:', selectedDates);
            
            // Auto-navigate to show the selected dates
            console.log('About to call autoNavigateToSelectedDates');
            autoNavigateToSelectedDates();
        }
        
        function autoNavigateToSelectedDates() {
            if (selectedDates.length === 0) return;
            
            // Find the earliest selected date
            const earliestDate = new Date(selectedDates[0]);
            const earliestMonth = earliestDate.getMonth();
            const earliestYear = earliestDate.getFullYear();
            
            console.log('Auto-navigate check:', {
                earliestDate: earliestDate.toISOString().slice(0, 10),
                earliestMonth,
                earliestYear,
                currentMonth: currentMonth.getMonth(),
                currentYear: currentMonth.getFullYear()
            });
            
            // Always navigate to show the selected month as the left month
            console.log('Navigating to show selected month as left calendar');
            currentMonth.setMonth(earliestMonth);
            currentMonth.setFullYear(earliestYear);
            
            // Re-render the calendar
            const calendarGrid = document.getElementById('calendarGrid');
            const currentMonthDisplay = document.getElementById('currentMonthDisplay');
            
            calendarGrid.innerHTML = '';
            const nextMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
            console.log('Rendering months:', currentMonth.toLocaleString(), 'and', nextMonth.toLocaleString());
            
            calendarGrid.appendChild(renderMonth(currentMonth, availabilityData));
            calendarGrid.appendChild(renderMonth(nextMonth, availabilityData));
            currentMonthDisplay.textContent = `${currentMonth.toLocaleString(undefined, { month: 'long', year: 'numeric' })} & ${nextMonth.toLocaleString(undefined, { month: 'long', year: 'numeric' })}`;
            
            console.log('Calendar re-rendered, available dates:', document.querySelectorAll('.date.available').length);
            
            // Re-highlight selected dates after rendering
            highlightAllSelectedDates();
        }
        
        function isDateAvailable(dateStr) {
            const unavailableSet = new Set();
            (availabilityData.unavailable || []).forEach(r => {
                const start = new Date(r.start);
                const end = new Date(r.end);
                console.log('Processing unavailable range:', r.start, 'to', r.end);
                
                // Create a copy of the start date to avoid modifying the original
                const currentDate = new Date(start);
                while (currentDate <= end) {
                    const dateKey = currentDate.toISOString().slice(0, 10);
                    unavailableSet.add(dateKey);
                    console.log('Added unavailable date:', dateKey);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            });
            
            // Also check for booked dates from localStorage
            const bookedDates = JSON.parse(localStorage.getItem('bookedDates') || '[]');
            bookedDates.forEach(date => {
                unavailableSet.add(date);
                console.log('Added booked date as unavailable:', date);
            });
            
            const today = new Date();
            const todayStr = today.toISOString().slice(0,10);
            
            const isUnavailable = unavailableSet.has(dateStr);
            const isPast = dateStr < todayStr;
            const isAvailable = !isUnavailable && !isPast;
            
            console.log('isDateAvailable check for', dateStr, ':', {
                isUnavailable,
                isPast,
                isAvailable,
                todayStr,
                bookedDates: bookedDates,
                unavailableDates: Array.from(unavailableSet).sort()
            });
            
            return isAvailable;
        }
        
        function highlightAllSelectedDates() {
            console.log('highlightAllSelectedDates called with:', selectedDates);
            
            // Clear all existing selections first
            const allCells = document.querySelectorAll('.date');
            allCells.forEach(cell => {
                cell.classList.remove('selected');
                cell.style.backgroundColor = '';
                cell.style.color = '';
                cell.style.border = '';
            });
            
            // Highlight all selected dates using data attributes
            selectedDates.forEach(dateStr => {
                console.log('Looking for cell with data-date:', dateStr);
                const cell = document.querySelector(`[data-date="${dateStr}"]`);
                if (cell && !cell.classList.contains('disabled')) {
                    console.log('Found and highlighting cell for:', dateStr);
                    cell.classList.add('selected');
                    cell.style.backgroundColor = '#dc2626';
                    cell.style.color = '#fff';
                    cell.style.border = '1px solid #b91c1c';
                    console.log('Applied styles to cell:', cell);
                } else {
                    console.log('Cell not found or disabled for:', dateStr);
                }
            });
            
            console.log('Highlighting complete');
        }
        
        function clearSelection() {
            selectedDates = [];
            // Remove all selected styling
            const cells = document.querySelectorAll('.date');
            cells.forEach(cell => {
                cell.classList.remove('selected');
                cell.style.backgroundColor = '';
                cell.style.color = '';
                cell.style.border = '';
            });
        }
        
        
        function updatePricingCalculator() {
            const calculator = document.getElementById('pricingCalculator');
            const selectedDatesDiv = document.getElementById('selectedDates');
            const pricingBreakdown = document.getElementById('pricingBreakdown');
            const totalCost = document.getElementById('totalCost');
            
            if (selectedDates.length === 0) {
                calculator.style.display = 'none';
                return;
            }
            
            calculator.style.display = 'block';
            
            // Show selected dates
            const startDate = new Date(selectedDates[0]);
            const endDate = new Date(selectedDates[selectedDates.length - 1]);
            const days = selectedDates.length;
            
            selectedDatesDiv.textContent = `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()} (${days} day${days > 1 ? 's' : ''})`;
            
            // Calculate pricing
            const dailyCost = days * 70; // ¬£70 per day
            
            // Get individual delivery and collection costs
            let deliveryCost, collectionCost;
            const postcode = document.getElementById('postcodeInput').value.toUpperCase().trim();
            
            if (postcode.startsWith('EN10')) {
                deliveryCost = 75;
                collectionCost = 75;
            } else {
                // Get the individual costs based on distance
                const individualCost = getIndividualDeliveryCost();
                deliveryCost = individualCost;
                collectionCost = individualCost;
            }
            
            pricingBreakdown.innerHTML = `
                <div style="display: flex; justify-content: space-between;">
                    <span>Daily hire (${days} day${days > 1 ? 's' : ''} √ó ¬£70)</span>
                    <span>¬£${dailyCost}</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Delivery</span>
                    <span>¬£${deliveryCost}</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Collection</span>
                    <span>¬£${collectionCost}</span>
                </div>
            `;
            
            const total = dailyCost + deliveryCost + collectionCost;
            totalCost.textContent = `Total: ¬£${total} + VAT`;
        }
        
        function getIndividualDeliveryCost() {
            const postcode = document.getElementById('postcodeInput').value.toUpperCase().trim();
            if (!postcode) return 0;
            
            // Special rate for EN10 7EU area (up to 20 miles)
            if (postcode.startsWith('EN10')) {
                return 75; // ¬£75 for delivery, ¬£75 for collection
            }
            
            // More accurate distance estimation from Broxbourne, Hertfordshire
            const postcodeArea = postcode.substring(0, 2);
            const distanceMap = {
                // Hertfordshire & nearby (0-50 miles)
                'EN': 5, 'AL': 15, 'HP': 20, 'LU': 25, 'MK': 30, 'SG': 35, 'CB': 40, 'CM': 45, 'CO': 50,
                
                // London areas (10-30 miles)
                'E': 15, 'EC': 20, 'N': 10, 'NW': 12, 'SE': 18, 'SW': 20, 'W': 15, 'WC': 18,
                'IG': 20, 'RM': 25, 'DA': 25, 'BR': 30, 'CR': 35, 'KT': 40, 'SM': 35, 'TW': 45,
                'UB': 50, 'HA': 40, 'WD': 45,
                
                // South East (50-100 miles)
                'SL': 55, 'RG': 60, 'GU': 65, 'PO': 70, 'SO': 75, 'BH': 80, 'DT': 85, 'SP': 90, 'OX': 95,
                
                // Midlands (100-150 miles)
                'BA': 105, 'SN': 110, 'WR': 115, 'CV': 120, 'B': 125, 'DY': 130, 'WS': 135, 'WV': 140,
                'ST': 145, 'TF': 150,
                
                // North England (150-200 miles)
                'SY': 155, 'HR': 160, 'LD': 165, 'NP': 170, 'CF': 175, 'SA': 180, 'LL': 185, 'CH': 190,
                'L': 195, 'M': 200, 'SK': 205, 'OL': 210, 'BL': 215, 'PR': 220, 'FY': 225,
                
                // North England & Scotland (200-300+ miles)
                'BB': 230, 'BD': 235, 'HD': 240, 'HX': 245, 'LS': 250, 'S': 255, 'WF': 260,
                'DN': 265, 'HU': 270, 'YO': 275, 'NE': 280, 'DH': 285, 'SR': 290, 'TS': 295,
                'DL': 300, 'HG': 305, 'LA': 310, 'CA': 315, 'TD': 320, 'EH': 325, 'FK': 330,
                'G': 335, 'KA': 340, 'KY': 345, 'ML': 350, 'PA': 355, 'PH': 360, 'AB': 365,
                'DD': 370, 'IV': 375, 'KW': 380, 'ZE': 385
            };
            
            const estimatedMiles = distanceMap[postcodeArea] || 100;
            
            const deliveryRates = [
                { maxMiles: 50, price: 75 },   // ¬£75 for delivery, ¬£75 for collection
                { maxMiles: 100, price: 100 }, // ¬£100 for delivery, ¬£100 for collection
                { maxMiles: 150, price: 125 }, // ¬£125 for delivery, ¬£125 for collection
                { maxMiles: 200, price: 150 }, // ¬£150 for delivery, ¬£150 for collection
                { maxMiles: 300, price: 225 }  // ¬£225 for delivery, ¬£225 for collection
            ];
            
            for (const rate of deliveryRates) {
                if (estimatedMiles <= rate.maxMiles) {
                    return rate.price;
                }
            }
            
            return deliveryRates[deliveryRates.length - 1].price;
        }
        
        function getDeliveryCost() {
            // This function now returns the total cost (delivery + collection)
            const individualCost = getIndividualDeliveryCost();
            return individualCost * 2; // Double for total delivery + collection
        }
        
        // Email Quote Modal Functions
        function showEmailQuoteModal() {
            const modal = document.getElementById('emailQuoteModal');
            modal.style.display = 'block';
            
            // Set up modal event listeners (only once)
            const cancelBtn = document.getElementById('cancelEmailQuote');
            const form = document.getElementById('emailQuoteForm');
            
            // Remove any existing listeners to prevent duplicates
            cancelBtn.replaceWith(cancelBtn.cloneNode(true));
            form.replaceWith(form.cloneNode(true));
            
            // Add fresh event listeners
            document.getElementById('cancelEmailQuote').addEventListener('click', hideEmailQuoteModal);
            document.getElementById('emailQuoteForm').addEventListener('submit', handleEmailQuoteSubmit);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    hideEmailQuoteModal();
                }
            });
        }
        
        function hideEmailQuoteModal() {
            const modal = document.getElementById('emailQuoteModal');
            modal.style.display = 'none';
            
            // Clear form
            document.getElementById('emailQuoteForm').reset();
            const messageDiv = document.getElementById('emailQuoteMessage');
            messageDiv.style.display = 'none';
            messageDiv.textContent = '';
        }
        
        async function handleEmailQuoteSubmit(e) {
            e.preventDefault();
            
            const name = document.getElementById('quoteName').value.trim();
            const email = document.getElementById('quoteEmail').value.trim();
            const phone = document.getElementById('quotePhone').value.trim();
            const notes = document.getElementById('quoteNotes').value.trim();
            const postcode = document.getElementById('postcodeInput').value.toUpperCase().trim();
            
            if (!name || !email) {
                showEmailQuoteMessage('Please fill in your name and email address.', 'error');
                return;
            }
            
            // Calculate quote details
            const startDate = new Date(selectedDates[0]);
            const endDate = new Date(selectedDates[selectedDates.length - 1]);
            const days = selectedDates.length;
            const dailyCost = days * 70;
            const deliveryCost = getIndividualDeliveryCost();
            const collectionCost = deliveryCost;
            const totalCost = dailyCost + deliveryCost + collectionCost;
            
            const quoteData = {
                name: name,
                email: email,
                phone: phone,
                notes: notes,
                postcode: postcode,
                selectedDates: selectedDates,
                startDate: startDate.toISOString().slice(0, 10),
                endDate: endDate.toISOString().slice(0, 10),
                days: days,
                dailyCost: dailyCost,
                deliveryCost: deliveryCost,
                collectionCost: collectionCost,
                totalCost: totalCost
            };
            
            const sendBtn = document.getElementById('sendEmailQuote');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';
            
            try {
                const response = await fetch('/send-quote-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(quoteData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showEmailQuoteMessage('‚úÖ Quote sent successfully! Check your email inbox.', 'success');
                    setTimeout(() => {
                        hideEmailQuoteModal();
                    }, 2000);
                } else {
                    showEmailQuoteMessage('‚ùå Failed to send quote. Please try again or contact us directly.', 'error');
                }
            } catch (error) {
                console.error('Error sending quote email:', error);
                showEmailQuoteMessage('‚ùå Failed to send quote. Please try again or contact us directly.', 'error');
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'üìß Send Quote';
            }
        }
        
        function showEmailQuoteMessage(message, type) {
            const messageDiv = document.getElementById('emailQuoteMessage');
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            
            if (type === 'success') {
                messageDiv.style.backgroundColor = '#f0fdf4';
                messageDiv.style.color = '#166534';
                messageDiv.style.border = '1px solid #bbf7d0';
            } else {
                messageDiv.style.backgroundColor = '#fef2f2';
                messageDiv.style.color = '#dc2626';
                messageDiv.style.border = '1px solid #fecaca';
            }
        }
        
        // Check if dates from email are still available
        function checkDateAvailability(dateArray) {
            const unavailableDates = [];
            
            dateArray.forEach(dateStr => {
                if (!isDateAvailable(dateStr)) {
                    unavailableDates.push(dateStr);
                }
            });
            
            return unavailableDates;
        }
        
        // Show message when dates from email are no longer available
        function showDateUnavailableMessage(unavailableDates) {
            // Create or find the message container
            let messageContainer = document.getElementById('dateUnavailableMessage');
            if (!messageContainer) {
                messageContainer = document.createElement('div');
                messageContainer.id = 'dateUnavailableMessage';
                messageContainer.style.cssText = `
                    background: #fef2f2;
                    border: 1px solid #fecaca;
                    border-radius: 0.5rem;
                    padding: 1rem;
                    margin: 1rem 0;
                    color: #dc2626;
                `;
                
                // Insert after the pricing calculator
                const calculator = document.getElementById('pricingCalculator');
                if (calculator) {
                    calculator.parentNode.insertBefore(messageContainer, calculator.nextSibling);
                } else {
                    // Insert after the calendar grid
                    const calendarGrid = document.getElementById('calendarGrid');
                    calendarGrid.parentNode.insertBefore(messageContainer, calendarGrid.nextSibling);
                }
            }
            
            const unavailableDatesList = unavailableDates.map(date => {
                const dateObj = new Date(date);
                return dateObj.toLocaleDateString();
            }).join(', ');
            
            messageContainer.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                    <span style="font-size: 1.25rem; margin-right: 0.5rem;">‚ö†Ô∏è</span>
                    <strong>Dates No Longer Available</strong>
                </div>
                <p style="margin: 0 0 0.5rem 0;">The following dates from your quote are no longer available: <strong>${unavailableDatesList}</strong></p>
                <p style="margin: 0; font-size: 0.875rem;">Please select different dates from the calendar above to continue with your booking.</p>
            `;
            
            messageContainer.style.display = 'block';
        }
    </script>

    <!-- WhatsApp Button -->
    <a href="https://wa.me/447342606655?text=Hi%20Kitchen%20Rescue,%20I%27d%20like%20to%20enquire%20about%20temporary%20kitchen%20hire" 
       class="whatsapp-button" 
       target="_blank" 
       rel="noopener noreferrer"
       aria-label="Chat with us on WhatsApp">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
        </svg>
    </a>
</body>
</html>

